<html>

<head>
        <style>
                body {
			overflow: visible;
                        font-size: 1.2em;
			margin: 0 0 0 0;
                        border: 0 0 0 0;
                        padding: 0 0 0 0;
                        background: #a0a0a0;
                }

		#outer {
			margin: 0 0 0 0;
			padding: 0 0 0 0;
			border: 0 0 0 0;
			display: block;
                }

		#buttonsDiv {
			margin: auto;
			width: 100%;
			text-align: center;
			cursor: pointer;
		}

		.buttonBusy {
			background-color: #ed558a;
		}

                #pageCollDiv {
                        overflow-y: scroll;
                        background: #dadada;
                        display: inline-block;
			margin: 0 0 0 0;
			padding: 0 0 0 0;
			border: 0 0 0 0;
                }

		#workingPane {
			float: right;
                        overflow-x: scroll;
                        overflow-y: scroll;
                        background: #606060;
                        display: inline-block;
			margin: 0 0 0 0;
			padding: 0 0 0 0;
			border: 0 0 0 0;
		}

                .button {
                        margin: auto;
                        height: 50px;
			min-width: 100px;
                        font-size: 1em;
			margin: 0 auto;
                }

		.mainButtons {
			display: inline-block;
		}

		.aPage {
			margin: 1px;
			padding: 3px;
			cursor: pointer;
			border: 1px solid transparent;
		}

		.aPage:hover {
			background: #ffffff;
			border: 1px solid #f27d00;
		}
		

            #notifications {
                background: #b61818;
                color: #ffffff;
                border-radius: 8px; 
                font-size: 1.5em; 
                display: block;
                opacity: 0.8; 
                padding: 8px; 
                padding-left: 12px;
                padding-right: 12px;
                text-align: center;
                position: fixed;
                z-index: 99;
                top: 20px;
                right: 20px;

                visibility: hidden;
            }  

        </style>

        <script>

		let langs = ['en', 'es', 'fr', 'de', 'ja'];
		let langName = {'en': 'English', 'es': 'Spanish', 'fr': 'French', 'de': 'German', 'ja': 'Japanese'};

		function hideNotification() {
		    document.getElementById("notifications").style.visibility = "hidden";
		}
		
		function showNotification(note, waitTime) {
		    document.getElementById("notifications").innerHTML = note;
		    document.getElementById("notifications").style.visibility = "visible";
		    if (waitTime > 0) {
		        //setTimeout(hideNotification, waitTime);
		    } else {
		        setTimeout(hideNotification, 1500);
		    }
		}
		

                function getCookie(cookieName) {
                        let name = cookieName + "=";
                        let decodedCookie = decodeURIComponent(document.cookie);
                        let cookies = decodedCookie.split(';');
                        for (let i = 0; i < cookies.length; i++) {
                                let cookie = cookies[i];
                                while (cookie.charAt(0) == ' ') {
                                        cookie = cookie.substring(1);
                                }
                                if (cookie.indexOf(name) == 0) {
                                        return cookie.substring(name.length, cookie.length);
                                }
                        }
                        return "";
                }
                let sessionId = getCookie('sessionid');

		function resizer() {
			let myHeight = document.documentElement.clientHeight;
			let myWidth = document.documentElement.clientWidth;
			let pageCollDiv = document.getElementById("pageCollDiv");
			let workingPane = document.getElementById("workingPane");
			let outer = document.getElementById("outer");
			outer.style.height = myHeight + "px";
			outer.style.width = myWidth + "px";
			pageCollDiv.style.height = myHeight + "px";
			pageCollDiv.style.width = ((myWidth * 0.25) - 2) + "px";
			workingPane.style.height = myHeight + "px";
			workingPane.style.width = ((myWidth * 0.75) - 2) + "px";

		}

		function pullCheck() {
			fetch(`/pullcheck?session=${sessionId}`, {
				cache: "no-cache", 
				headers: {"Content-Type": "application/json"}
			})
			.then((data) => data.json())
			.then((content) => {
				if (content['status'] == 0) {
					window.setTimeout(pullCheck, 5000);
					if (! document.getElementById("pullButton").classList.contains('buttonBusy')) {
						document.getElementById("pullButton").classList.add('buttonBusy');
					}
				} else {
					document.getElementById("pullButton").classList.remove('buttonBusy');
					pullContent();
				}
			});
		}

		function pull() {
			document.getElementById("pullButton").classList.add('buttonBusy');

			let data = {
				"session": sessionId,
				"pull": 1,
				"push": 0,
				"scope": ""
			}

			fetch("/pull", {
				method: "POST", 
				cache: "no-cache", 
				headers: {"Content-Type": "application/json"},
				body: JSON.stringify(data)
			})
			.then((data) => data.json())
			.then((content) => {
				console.log(content);
				if (content['status'] == 1) {
					showNotification("Pulling...");
				} else {
					showNotification("Pull request failed");
				}
				window.setTimeout(pullCheck, 5000);
			});
		}

		function pullContent() {
			let data = {
				"session": sessionId,
				"pages": 1,
				"collections": 1,
				"scope": ""
			}

			fetch("/pullcontent", {
				method: "POST", 
				cache: "no-cache", 
				headers: {"Content-Type": "application/json"},
				body: JSON.stringify(data)
			})
			.then((data) => data.json())
			.then((preContent) => {
				console.log(preContent);
				if (preContent['status'] == 1) {
					let content = preContent.content;
					let docEle;
					let parentEle = document.getElementById('dataColl');
					content.pages.forEach((pageNow) => {
						docEle = document.createElement("div");
						docEle.setAttribute("id", `page_${pageNow[0]}`);
						docEle.setAttribute("class", `aPage`);
						docEle.setAttribute("onclick", `pullTrans(${pageNow[0]}, 0)`);
						docEle.innerHTML = (pageNow[2] == null || pageNow[2] == undefined) ? `${pageNow[1]}` : `${pageNow[1]} / ${pageNow[2]}`;
						parentEle.append(docEle);
					});
				}
			});
		}

		function pullTrans(pageId = 0, collectionId = 0) {
			let data = {
				"session": sessionId,
				"page": pageId,
				"collection": collectionId,
				"scope": ""
			}

			fetch("/pulltrans", {
				method: "POST", 
				cache: "no-cache", 
				headers: {"Content-Type": "application/json"},
				body: JSON.stringify(data)
			})
			.then((data) => data.json())
			.then((preContent) => {
				console.log(preContent);
				if (preContent['status'] == 1) {
					let translations = document.getElementById('translations');
					if (translations == undefined) {
						translations = document.createElement('div');
						translations.setAttribute('id', 'translations');
						document.getElementById('workingPane').append(translations);
					}

					let transTable = document.createElement('table');
					transTable.setAttribute('id', 'transTable');
					translations.append(transTable);

					let transTr = document.createElement('tr');
					transTable.append(transTr);
					let transTd = document.createElement('td');
					transTr.append(transTd);
					langs.forEach((lang) => {
						transTd = document.createElement('td');
						transTr.append(transTd);
						transTd.innerHTML = langName[lang];
					});

					let content = preContent.content;

					langs.forEach((lang) => {
						Object.keys(content.pages[lang]).forEach((trKey) => {
							//content.pages[lang][trKey]
							
						});
					});
				}
			});
		}

		window.addEventListener("load", function(e) {
			let notif = document.createElement("div");
			notif.setAttribute("id", "notifications");
			document.body.append(notif);
			pullContent();
			window.setTimeout(pullCheck, 500);
		});

        </script>
</head>

<body>

	<div id="outer">
		<div id="pageCollDiv">
			<div id="buttonsDiv">
                       		<button type="button" id="pullButton" class="button mainButtons">Pull</button>
                       		<!--<button type="button" id="pushButton" class="button mainButtons">Push</button>-->
			</div>
			<div id="dataColl">
			</div>
		</div>
		<div id="workingPane">
		</div>
	</div>


</body>

<script>
        document.getElementById('pullButton').addEventListener(
                "click",
                (event) => {
			pull();
                }
        );

	window.addEventListener(
		"resize",
		(event) => {
			resizer();
		}
	);

	resizer();
</script>

</html>
